<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.tailwindcss.com"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script>
            const emptyResult = { title: "", links: [] };
            const regexKKO = /KKO[ \/:]?((?:(?<year1>\d{4})[:\/](?<caseNo1>\d{1,3}))|(?:(?<caseNo2>\d{1,3})[:\/](?<year2>\d{4})))/i;
            const regexHE = /HE[ \/:]?((?:(?<caseNo1>\d{1,4})[:\/](?<year1>\d{4}))|(?:(?<year2>\d{4})[:\/](?<caseNo2>\d{1,4})))(?: vp)?/i;

            document.addEventListener('alpine:init', () => {                            
                Alpine.data('jump', () => ({
                    result: emptyResult,
                    error: undefined,
                    /*result: { title: "KKO 201E8:22", links: [
                        {
                            title: "Finlex",
                            href: "https://finlex.fi"
                        }
                    ]},*/
         
                    search(e) {
                        const needle = e.target.value;
                        
                        let match = undefined

                        this.error = undefined;

                        if ((match = needle.match(regexKKO)) !== null) {
                            this.result = this.getKKOResult(match.groups);
                        } else if ((match = needle.match(regexHE)) !== null) {
                            this.result = this.getHEResult(match.groups);
                        } else {
                            this.error = "En valitettavasti ymmärrä. Kokeile esim. KKO 2013:82 tai HE 65/2015";
                            this.result = emptyResult;
                        }
                    },
                    go() {
                        if (this.result.links.length > 0) {
                            window.location = this.result.links[0].href;
                        }
                    },
                    getKKOResult({ year1, caseNo1, year2, caseNo2 }) {
                        const year = year1 || year2;
                        const caseNo = caseNo1 || caseNo2;

                        return {
                            title: `KKO:${year}:${caseNo}`,
                            links: [
                                {
                                    title: "Finlex",
                                    href: `https://www.finlex.fi/fi/oikeus/kko/kko/${year}/${year}${this.leftpad(caseNo, 4, '0')}`
                                },
                                {
                                    title: "Edilex",
                                    href: `https://www.edilex.fi/kko/ennakkopaatokset/${year}${this.leftpad(caseNo, 4, '0')}`
                                }
                            ]
                        }
                    },
                    getHEResult({ year1, caseNo1, year2, caseNo2 }) {
                        const year = year1 || year2;
                        const caseNo = caseNo1 || caseNo2;
                    
                        return {
                            title: `HE ${caseNo}/${year}`,
                            links: [
                                {
                                    title: "Finlex",
                                    href: `https://www.finlex.fi/fi/esitykset/he/${year}/${year}${this.leftpad(caseNo, 4, '0')}`
                                },
                                {
                                    title: "Eduskunta",
                                    href: `https://www.eduskunta.fi/FI/vaski/HallituksenEsitys/Sivut/HE_${caseNo}+${year}.aspx`
                                },
                                {
                                    title: "Edilex",
                                    href: `https://www.edilex.fi/he/${year}${this.leftpad(caseNo, 4, '0')}`
                                }
                            ]
                        }
                    },                    
                    leftpad(input, length, pad) {
                        const padLength = Math.max(0, length - input.length);

                        return `${[...Array(padLength).keys()].map(_ => pad).join("")}${input}`;
                    }
                }))
            })
        </script>
    </head>
    <body>
        <div 
            x-data="jump"             
            x-init="$refs.needle.focus()"
            class="container mx-auto p-4 flex flex-col items-center gap-2">
            
            <input 
                type="text"
                x-ref="needle"
                @keyup.debounce="search"
                @keyup.enter="go" 
                placeholder="KKO 2013:82" 
                class="block border-4 rounded-lg text-center text-xl"/>

            <span x-text="error" class="italic"></span>

            <div class="flex flex-row gap-2">                
                <template x-for="link in result.links">                    
                    <a                         
                        :href="link.href"
                        class="block flex flex-col gap-2 border-2 p-4 rounded-lg text-center drop-shadow">
                        <span x-text="link.title" class="font-bold text-lg"></span>
                        <span x-text="result.title" class="text-sm"></span>
                    </a>                
                </template>
            </div>
        </div>
    </body>
</html>