<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.tailwindcss.com"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <script>
            const emptyResult = { title: "", links: [] };
            const regexKKO = /KKO[ \/:]?((?:(?<year1>\d{4})[:\/](?<caseNo1>\d{1,3}))|(?:(?<caseNo2>\d{1,3})[:\/](?<year2>\d{4})))/i;            

            document.addEventListener('alpine:init', () => {            
                Alpine.data('jump', () => ({
                    result: emptyResult,
                    error: undefined,
                    /*result: { title: "KKO 2018:22", links: [
                        {
                            title: "Finlex",
                            href: "https://finlex.fi"
                        }
                    ]},*/
         
                    search(e) {
                        var needle = e.target.value;
                    
                        var match = needle.match(regexKKO);                

                        this.error = undefined;

                        if (match !== null) {
                            this.result = this.getKKOResult(match.groups);
                        } else {
                            this.error = "Ei tuloksia";
                            this.result = emptyResult;
                        }
                    },
                    go() {
                        if (this.result.links.length > 0) {
                            window.location = this.result.links[0].href;
                        }
                    },
                    getKKOResult({ year1, caseNo1, year2, caseNo2 }) {
                        const year = year1 || year2;
                        const caseNo = caseNo1 || caseNo2;

                        return {
                            title: `KKO ${year}:${caseNo}`,
                            links: [
                                {
                                    title: "Finlex",
                                    href: `https://www.finlex.fi/fi/oikeus/kko/kko/${year}/${year}${this.leftpad(caseNo, 4, '0')}`
                                }
                            ]
                        }
                    },
                    leftpad(input, length, pad) {
                        const padLength = Math.max(0, length - input.length);

                        return `${[...Array(padLength).keys()].map(_ => pad).join("")}${input}`;
                    }
                }))
            })
        </script>
    </head>
    <body>
        <div 
            x-data="jump"             
            class="container mx-auto my-4 flex flex-col items-center gap-2">
            <input 
                type="text" 
                @keyup="search"
                @keyup.enter="go" 
                placeholder="KKO 2022:18" 
                class="block border-4 rounded-lg text-center text-xl"/>

            <span x-text="error"></span>

            <div class="flex flex-row">                
                <template x-for="link in result.links">                    
                    <a                         
                        :href="link.href"
                        class="block flex flex-col gap-2 border-2 p-4 rounded-lg text-center drop-shadow">
                        <span x-text="link.title" class="font-bold text-lg"></span>
                        <span x-text="result.title" class="text-sm"></span>
                    </a>                
                </template>
            </div>
        </div>
    </body>
</html>